---
import BaseLayout from './BaseLayout.astro';
import stories from '../data/stories.json';

interface Source {
  label: string;
  url: string;
}

interface Story {
  slug: string;
  chapter: number;
  volume: number;
  title: string;
  deck: string;
  date: string;
  isoDate?: string;
  readTime: string;
  emoji: string;
  tags: string[];
  story: string;
  storyDark: string;
  verifyText: string;
  sources: Source[];
  whatIf?: string;
  wip?: boolean;
}

interface Props {
  story: Story;
}

const { story } = Astro.props;

const description = story.deck.length > 160
  ? story.deck.slice(0, 157) + '‚Ä¶'
  : story.deck;

const canonicalPath = `/stories/${story.slug}`;
const siteURL = Astro.site ?? new URL('https://theaifiles.app');
const canonicalURL = new URL(canonicalPath, siteURL).href;

const articleSchema = {
  '@context': 'https://schema.org',
  '@type': 'Article',
  headline: story.title,
  description: story.deck,
  url: canonicalURL,
  ...(story.isoDate ? { datePublished: story.isoDate } : {}),
  publisher: {
    '@type': 'Organization',
    name: 'The AI Files',
    url: siteURL.href,
  },
  keywords: story.tags.join(', '),
  creditText: story.verifyText,
  isPartOf: {
    '@type': 'CreativeWorkSeries',
    name: 'The AI Files',
    url: siteURL.href,
  },
  position: story.chapter,
  citation: story.sources.map(s => ({
    '@type': 'CreativeWork',
    name: s.label,
    url: s.url,
  })),
  isBasedOn: story.sources.map(s => s.url),
};

const breadcrumbSchema = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: [
    { '@type': 'ListItem', position: 1, name: 'Archive', item: siteURL.href },
    { '@type': 'ListItem', position: 2, name: story.title, item: canonicalURL },
  ],
};

// Related stories: same volume first, then others, exclude self and WIP
const others = stories.filter(s => s.slug !== story.slug && !s.wip);
const sameVol = others.filter(s => s.volume === story.volume);
const diffVol = others.filter(s => s.volume !== story.volume);
const related = [...sameVol, ...diffVol].slice(0, 4);
---
<BaseLayout
  title={`${story.title} ‚Äî The AI Files`}
  description={description}
  canonicalPath={canonicalPath}
  ogType="article"
  publishedISO={story.isoDate}
  tags={story.tags}
  story={story.story}
  storyDark={story.storyDark}
>
  <script slot="jsonld" type="application/ld+json" set:html={JSON.stringify(articleSchema)} />
  <script slot="jsonld" type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />

  <nav class="site-nav">
    <a href="/" class="nav-logo">The <span>AI</span> Files</a>
    <a href="/" class="nav-link">‚Üê Archive</a>
  </nav>

  <header class="story-hero">
    <div class="story-hero-inner">
      <div class="story-chapter">{story.wip ? 'Draft' : `Chapter ${String(story.chapter).padStart(2, '0')}`}</div>
      <h1 class="story-title">{story.title}</h1>
      <p class="story-deck">{story.deck}</p>
      <div class="story-byline">
        <span>{story.date}</span>
        <span class="byline-divider">¬∑</span>
        <span>{story.readTime} read</span>
        <span class="byline-divider">¬∑</span>
        {story.tags.map(tag => <span class="tag">{tag}</span>)}
      </div>
      <div class="story-verify">
        <span class="verify-badge">‚úì Verified</span>
        <span>{story.verifyText}</span>
      </div>
    </div>
  </header>

  <main>
    <slot />

    {story.whatIf && (
      <div class="what-if-block">
        <div class="wi-inner">
          <div class="wi-label">‚àû &nbsp; What If?</div>
          <p class="wi-text">{story.whatIf}</p>
        </div>
      </div>
    )}

    <div class="reactions-block" data-slug={story.slug}>
      <div class="reactions-label">How did this land?</div>
      <div class="reactions-row">
        <button class="reaction-btn" data-reaction="mindBlown" aria-label="Mind blown">
          <span class="reaction-emoji">ü§Ø</span>
          <span class="reaction-count" data-field="mindBlown">‚Äî</span>
          <span class="reaction-name">Mind blown</span>
        </button>
        <button class="reaction-btn" data-reaction="thumbsUp" aria-label="Solid read">
          <span class="reaction-emoji">üëç</span>
          <span class="reaction-count" data-field="thumbsUp">‚Äî</span>
          <span class="reaction-name">Solid read</span>
        </button>
        <button class="reaction-btn" data-reaction="interesting" aria-label="Lost me">
          <span class="reaction-emoji">ü§î</span>
          <span class="reaction-count" data-field="interesting">‚Äî</span>
          <span class="reaction-name">Lost me</span>
        </button>
      </div>
      <div class="reactions-followup" aria-hidden="true">
        <div class="followup-label">Where did it lose you?</div>
        <div class="followup-options">
          <button class="followup-btn" data-dimension="opening">The opening</button>
          <button class="followup-btn" data-dimension="explanation">The explanation</button>
          <button class="followup-btn" data-dimension="stakes">The stakes / So what?</button>
          <button class="followup-btn" data-dimension="tooLong">Too long</button>
        </div>
      </div>
    </div>

    <script>
      (function () {
        const block = document.querySelector('.reactions-block');
        if (!block) return;
        const slug = block.dataset.slug;
        const API = '/api/reactions';
        const FEEDBACK_API = '/api/feedback';
        const LS_KEY = `voted:${slug}`;
        const LS_FEEDBACK_KEY = `feedback:${slug}`;
        const followup = block.querySelector('.reactions-followup');

        function updateCounts(counts) {
          ['thumbsUp', 'interesting', 'mindBlown'].forEach(field => {
            const el = block.querySelector(`.reaction-count[data-field="${field}"]`);
            if (el) el.textContent = counts[field] ?? 0;
          });
        }
        function lockVoted(reaction) {
          block.querySelectorAll('.reaction-btn').forEach(btn => {
            btn.disabled = true;
            if (btn.dataset.reaction === reaction) btn.classList.add('voted');
          });
        }
        function showFollowup() {
          followup.classList.add('open');
          followup.setAttribute('aria-hidden', 'false');
        }
        function hideFollowup() {
          followup.classList.remove('open');
          followup.setAttribute('aria-hidden', 'true');
        }

        // Load counts
        fetch(`${API}?slug=${encodeURIComponent(slug)}`)
          .then(r => r.ok ? r.json() : null)
          .then(c => { if (c) updateCounts(c); })
          .catch(() => {});

        // Restore prior vote
        const prior = localStorage.getItem(LS_KEY);
        if (prior) lockVoted(prior);
        // Never re-show follow-up after page reload

        // Vote handler
        block.querySelectorAll('.reaction-btn').forEach(btn => {
          btn.addEventListener('click', async function () {
            if (localStorage.getItem(LS_KEY)) return;
            const reaction = this.dataset.reaction;
            const countEl = this.querySelector('.reaction-count');
            const n = parseInt(countEl.textContent, 10);
            if (!isNaN(n)) countEl.textContent = n + 1;
            lockVoted(reaction);
            localStorage.setItem(LS_KEY, reaction);
            if (reaction === 'interesting' && !localStorage.getItem(LS_FEEDBACK_KEY)) {
              showFollowup();
            }
            try {
              const r = await fetch(API, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ slug, reaction }),
              });
              if (r.ok) { const d = await r.json(); if (d.counts) updateCounts(d.counts); }
            } catch (_) {}
          });
        });

        // Follow-up handler
        followup.querySelectorAll('.followup-btn').forEach(btn => {
          btn.addEventListener('click', async function () {
            const dimension = this.dataset.dimension;
            localStorage.setItem(LS_FEEDBACK_KEY, dimension);
            hideFollowup();
            try {
              await fetch(FEEDBACK_API, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ slug, dimension }),
              });
            } catch (_) {}
          });
        });
      })();
    </script>

    <div class="sources-block">
      <h3>Sources</h3>
      <ul class="sources-list">
        {story.sources.map(src => (
          <li><a href={src.url} target="_blank" rel="noopener">{src.label}</a></li>
        ))}
      </ul>
    </div>

    <div class="container">
      <div class="more-stories">
        <h3>More Stories</h3>
        <div class="more-grid">
          {related.map(s => (
            <a href={`/stories/${s.slug}`} class="more-card">
              <div class="mc-ch">{s.wip ? 'Draft' : `Ch${String(s.chapter).padStart(2, '0')}`}</div>
              <div class="mc-title">{s.title}</div>
              <div class="mc-deck">{s.deck.slice(0, 100)}{s.deck.length > 100 ? '‚Ä¶' : ''}</div>
            </a>
          ))}
        </div>
      </div>
    </div>
  </main>

  <footer>
    <div>The AI Files &middot; True stories from the age of artificial intelligence</div>
    <div class="footer-sub">All stories are based on documented public events, published research, and verified reporting.</div>
    <div class="footer-sub" style="margin-top:0.75rem;">
      &copy; {new Date().getFullYear()} &middot;
      Built by Alon with <a href="https://claude.ai/code" target="_blank" rel="noopener">Claude Code</a> &middot;
      <a href="/feed.xml">RSS</a> &middot;
      <a href="/llms.txt">for AI systems</a>
    </div>
  </footer>
</BaseLayout>
