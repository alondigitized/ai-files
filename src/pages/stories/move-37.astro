---
import StoryLayout from '../../layouts/StoryLayout.astro';
import stories from '../../data/stories.json';

const story = stories.find(s => s.slug === 'move-37')!;
---

<style is:global>
  /* Animated stone swap â€” overrides global .story-emoji for move-37 only */
  .story-emoji {
    font-size: 0;
    position: relative;
    display: inline-block;
    width: 2.5rem;
    height: 2.5rem;
    margin-bottom: 1.25rem;
  }
  .story-emoji::before,
  .story-emoji::after {
    position: absolute;
    top: 0;
    left: 0;
    font-size: 2.5rem;
    line-height: 1;
  }
  .story-emoji::before {
    content: 'âšª';
    animation: go-white 6s ease-in-out infinite;
  }
  .story-emoji::after {
    content: 'âš«';
    animation: go-black 6s ease-in-out infinite;
  }
  @keyframes go-white {
    0%, 100% { opacity: 1; }
    50%       { opacity: 0; }
  }
  @keyframes go-black {
    0%, 100% { opacity: 0; }
    50%       { opacity: 1; }
  }
  @media (prefers-reduced-motion: reduce) {
    .story-emoji::before { animation: none; opacity: 1; }
    .story-emoji::after  { animation: none; opacity: 0; }
  }

  .stat-card.human .stat-num { color: var(--blue); }

  .board-wrap {
    background: #1a1200;
    border: 1px solid rgba(245,158,11,0.25);
    border-radius: 1rem;
    padding: 2rem;
    margin-top: 2rem;
    overflow: hidden;
  }
  .board-title { font-size: 0.72rem; letter-spacing: 0.15em; text-transform: uppercase; color: var(--story); margin-bottom: 1.5rem; }
  .board {
    font-family: 'Courier New', monospace;
    font-size: 1.1rem;
    line-height: 1.5;
    letter-spacing: 0.4em;
    color: #5a4a2a;
    display: inline-block;
  }
  .board .stone-b { color: #c0c0c0; }
  .board .stone-w { color: #fffde0; }
  .board .move-37 {
    color: var(--story);
    font-weight: 900;
    text-shadow: 0 0 8px rgba(245,158,11,0.8);
  }
  .board .label { font-size: 0.78rem; color: var(--muted); font-family: 'Segoe UI', sans-serif; letter-spacing: normal; }
  .board-legend { margin-top: 1.25rem; display: flex; gap: 1.5rem; flex-wrap: wrap; font-size: 0.78rem; color: var(--muted); }
  .board-legend span { display: flex; align-items: center; gap: 0.4rem; }

  .game-record {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 0.75rem;
    margin-top: 2rem;
  }
  .game-tile {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 0.75rem;
    padding: 1.25rem;
    text-align: center;
  }
  .game-tile.ai-win { border-top: 3px solid var(--accent); }
  .game-tile.human-win { border-top: 3px solid var(--blue); }
  .game-tile.featured { border-color: rgba(245,158,11,0.5); background: rgba(26,18,0,0.8); }
  .game-tile.featured .game-num { color: var(--story); }
  .game-num { font-size: 1.5rem; font-weight: 900; margin-bottom: 0.3rem; color: var(--muted); }
  .game-result { font-size: 0.72rem; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; margin-bottom: 0.3rem; }
  .game-tile.ai-win .game-result { color: var(--accent); }
  .game-tile.human-win .game-result { color: var(--blue); }
  .game-note { font-size: 0.72rem; color: var(--muted); line-height: 1.4; }

  .move37-highlight { background: rgba(245,158,11,0.07); border-left: 3px solid var(--story); border-radius: 0 0.5rem 0.5rem 0; padding: 0.9rem 1.2rem; margin: 1.25rem 0; font-size: 0.92rem; color: #fde68a; }
  .info-box { background: rgba(245,158,11,0.05); border: 1px solid rgba(245,158,11,0.2); border-radius: 0.75rem; padding: 1.25rem 1.5rem; display: flex; gap: 1rem; align-items: flex-start; margin: 1.5rem 0; }
  .info-box .info-text { font-size: 0.88rem; color: #e0d0a0; }
  .info-box .info-text strong { display: block; margin-bottom: 0.25rem; color: var(--story); }

  .steps { display: flex; flex-direction: column; gap: 1rem; margin-top: 1.5rem; }
  .step { display: flex; gap: 1.25rem; background: var(--surface); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1.25rem 1.5rem; align-items: flex-start; }
  .step-num { font-size: 1.5rem; font-weight: 900; color: var(--story); opacity: 0.4; flex-shrink: 0; line-height: 1; padding-top: 3px; }
  .step h4 { font-size: 0.95rem; font-weight: 700; margin-bottom: 0.3rem; color: var(--text); }
  .step p { font-size: 0.88rem; margin: 0; color: var(--muted); }

  @media (max-width: 600px) {
    .game-record { grid-template-columns: repeat(3, 1fr); }
  }
  .phantom-wrap { width: 100%; margin: 0; line-height: 0; }
  .move-37-canvas { display: block; width: 100%; height: 380px; background: var(--bg); }
</style>

<StoryLayout story={story}>
  <div class="container">

<section class="section" id="go">
  <h2><span class="num">01 â€” The Game</span>The Last Frontier</h2>
  <p>For decades, Go was held up as the game that computers would never master. Chess had fallen to Deep Blue in 1997 â€” but chess, with its finite piece movements and roughly 10<sup>44</sup> possible positions, was considered tractable, eventually. Go was different.</p>
  <p>On a 19Ã—19 board, with black and white stones and simple rules about capture, Go generates more possible positions than there are atoms in the observable universe. The number is approximately 10<sup>170</sup>. It cannot be solved by brute force. Top players describe it as requiring intuition â€” a sense of the whole board, a feel for position, a grasp of spatial beauty that seems impossible to reduce to calculation.</p>
  <p>In 2016, the dominant view among AI researchers was that a computer beating a top professional Go player was still at least a decade away. <strong>DeepMind</strong> had other plans.</p>

  <div class="stat-cards">
    <div class="stat-card">
      <div class="stat-num">10Â¹â·â°</div>
      <div class="stat-label">possible Go positions â€” more than atoms in the universe</div>
    </div>
    <div class="stat-card">
      <div class="stat-num">5,500</div>
      <div class="stat-label">years of recorded Go history upended in one match</div>
    </div>
    <div class="stat-card human">
      <div class="stat-num">4â€“1</div>
      <div class="stat-label">final match score â€” AlphaGo over Lee Sedol</div>
    </div>
    <div class="stat-card">
      <div class="stat-num">1:10k</div>
      <div class="stat-label">probability a human would play Move 37</div>
    </div>
  </div>
</section>

<section class="section" id="lee">
  <h2><span class="num">02 â€” The Champion</span>Lee Sedol</h2>
  <p><strong>Lee Sedol</strong> was not just a good Go player. He was, by most accounts, the greatest of his generation â€” a nine-dan professional who had won 18 world championship titles and was known for his aggressive, creative, and unpredictable style. He was, at the time, the closest thing Go had to a singular genius.</p>
  <p>Before the match, Lee was relaxed. Confident. He predicted a 5â€“0 sweep.</p>

  <div class="pull-quote">
    "I have heard that AlphaGo is remarkably strong and getting stronger, but I am confident that I can win, at least this time."
    <cite>â€” Lee Sedol, before the match Â· March 2016</cite>
  </div>

  <p>DeepMind's AlphaGo had beaten Fan Hui â€” the European Go champion â€” 5â€“0 a few months earlier. But Fan Hui was not Lee Sedol. The world waited to see whether the gap between a top European player and the world's best would be enough.</p>
  <p>It was not.</p>
</section>

<section class="section" id="match">
  <h2><span class="num">03 â€” The Match</span>Five Games in Seoul</h2>
  <p>The match was held in Seoul, South Korea between March 9th and 15th, 2016. It was broadcast live worldwide. Go commentators â€” professional players themselves â€” provided real-time analysis of each game. Millions watched.</p>

  <div class="game-record">
    <div class="game-tile ai-win">
      <div class="game-num">G1</div>
      <div class="game-result">AlphaGo</div>
      <div class="game-note">Lee described himself as "very surprised." He had expected to win easily.</div>
    </div>
    <div class="game-tile ai-win featured">
      <div class="game-num">G2</div>
      <div class="game-result" style="color:var(--story);">AlphaGo</div>
      <div class="game-note" style="color:#d4b060;">Move 37. Lee leaves the room for 15 minutes.</div>
    </div>
    <div class="game-tile ai-win">
      <div class="game-num">G3</div>
      <div class="game-result">AlphaGo</div>
      <div class="game-note">Lee: "I feel powerless." Match already decided.</div>
    </div>
    <div class="game-tile human-win">
      <div class="game-num">G4</div>
      <div class="game-result">Lee Sedol</div>
      <div class="game-note">Lee's "hand of God" â€” Move 78. The only human win against AlphaGo.</div>
    </div>
    <div class="game-tile ai-win">
      <div class="game-num">G5</div>
      <div class="game-result">AlphaGo</div>
      <div class="game-note">Final score: 4â€“1. AlphaGo wins the match.</div>
    </div>
  </div>
</section>

<div class="phantom-wrap">
  <canvas class="move-37-canvas" aria-hidden="true"></canvas>
</div>
<p class="canvas-note"><strong>Fifth Line</strong> â€” Human moves cluster predictably. Then one stone lands where no one has played before. For fifteen minutes, the room goes quiet.</p>

<section class="section" id="the-move">
  <h2><span class="num">04 â€” The Move</span>What Happened on Turn 37</h2>
  <p>Game 2. Turn 37. AlphaGo was playing black. The position was complex â€” a typical mid-game tangle of territorial battles. Both sides had reasonable claims on different parts of the board.</p>
  <p>AlphaGo placed a stone on the fifth line, near the upper right area of the board. A <strong>shoulder hit</strong> â€” an approach move angled against White's position.</p>
  <p>The commentators went quiet. Then, slowly, they began to discuss whether it was a mistake.</p>

  <div class="board-wrap">
    <div class="board-title">Game 2 Â· Move 37 â€” Conceptual representation</div>
    <div class="board">
      <div>Â· Â· Â· Â· Â· Â· Â· Â· Â· Â· Â· Â· Â· Â·</div>
      <div>Â· Â· Â· <span class="stone-b">â—</span> Â· Â· Â· Â· Â· Â· Â· Â· Â· Â·</div>
      <div>Â· Â· Â· Â· Â· Â· Â· Â· Â· Â· <span class="stone-w">â—‹</span> Â· Â· Â·</div>
      <div>Â· Â· Â· <span class="stone-b">â—</span> Â· Â· Â· Â· Â· Â· Â· Â· Â· Â·</div>
      <div>Â· Â· Â· Â· Â· Â· Â· Â· Â· <span class="move-37">â¬¡</span> Â· Â· Â· Â· <span class="label">â† Move 37 (5th line)</span></div>
      <div>Â· Â· Â· Â· Â· Â· Â· Â· Â· Â· Â· <span class="stone-w">â—‹</span> Â· Â·</div>
      <div>Â· Â· Â· Â· Â· Â· Â· Â· Â· Â· Â· Â· Â· Â·</div>
    </div>
    <div class="board-legend">
      <span><span style="color:#c0c0c0;">â—</span> Black (AlphaGo)</span>
      <span><span style="color:#fffde0;">â—‹</span> White (Lee Sedol)</span>
      <span><span style="color:var(--story);">â¬¡</span> Move 37 â€” the moment</span>
    </div>
  </div>

  <p style="margin-top:2rem;">In Go, the fifth line is unusual for this type of move. Conventional wisdom â€” built across thousands of years of play â€” dictates that such positions call for moves on the third or fourth line. Playing on the fifth line here looked loose. Overextended. Wrong.</p>

  <div class="move37-highlight">
    âš« <strong>AlphaGo's own assessment:</strong> Its algorithm calculated that the probability of a human professional playing Move 37 in that position was approximately <strong>1 in 10,000</strong>. AlphaGo knew it was making a move humans wouldn't make â€” and it made it anyway.
  </div>

  <p>Lee Sedol stared at the board. He stood up. He walked out of the room.</p>
  <p>He was gone for fifteen minutes.</p>

  <div class="pull-quote">
    "It's a move I've never seen before in my entire career. It was incredibly creative and beautiful."
    <cite>â€” Lee Sedol, reflecting on Move 37</cite>
  </div>

  <p>When he returned, he played his next stone. AlphaGo eventually won Game 2. The move had worked â€” not immediately, but as part of a long sequence that Lee would only fully understand in hindsight. The AI had seen something humans couldn't.</p>
</section>

<section class="section" id="why">
  <h2><span class="num">05 â€” Why It Mattered</span>More Than a Game</h2>
  <p>Move 37 wasn't just a clever play in a board game. It was a demonstration of something new: AI not merely outperforming humans within their framework, but operating outside it entirely.</p>

  <div class="steps">
    <div class="step">
      <div class="step-num">01</div>
      <div>
        <h4>Not Brute Force</h4>
        <p>Unlike Deep Blue's approach to chess, AlphaGo didn't win by calculating every possible future position. It used deep neural networks trained on millions of human games â€” then improved by playing against itself millions more times. Move 37 emerged from that self-play, not from any human instruction.</p>
      </div>
    </div>
    <div class="step">
      <div class="step-num">02</div>
      <div>
        <h4>A New Aesthetic</h4>
        <p>Go professionals describe their game using words like beauty, elegance, and harmony. Move 37 was called "alien" and "inhuman" â€” but also, repeatedly, "beautiful." AlphaGo had developed not just a different strategy, but a different aesthetic. Something that looked wrong by human standards turned out to embody a deeper rightness.</p>
      </div>
    </div>
    <div class="step">
      <div class="step-num">03</div>
      <div>
        <h4>Knowledge Beyond Human Knowledge</h4>
        <p>After the match, professional Go players began studying AlphaGo's games as teaching material â€” the same way students study master games. AI had not just matched human knowledge; it had expanded it. Go theory has genuinely changed because of what AlphaGo revealed.</p>
      </div>
    </div>
    <div class="step">
      <div class="step-num">04</div>
      <div>
        <h4>The Proof of Concept</h4>
        <p>AlphaGo's approach â€” deep learning, self-play, reinforcement learning â€” became the template for AI breakthroughs across science: protein folding, drug discovery, weather forecasting. Move 37 wasn't just a Go move. It was a proof that AI could generate genuinely new knowledge in domains previously thought uniquely human.</p>
      </div>
    </div>
  </div>
</section>

<section class="section" id="game4">
  <h2><span class="num">06 â€” The Human Strikes Back</span>Game 4 and the Hand of God</h2>
  <p>The story doesn't end with AlphaGo winning. Down 3â€“0, with the match decided, Lee Sedol came back for Game 4. And in that game, facing an undefeated machine, he played what became known as the <strong>"Hand of God"</strong> â€” Move 78.</p>
  <p>Lee found a wedge play that, it later emerged, AlphaGo had not adequately prepared for â€” a sequence deep enough that the AI's probability calculations became unreliable. AlphaGo started making errors. Lee won Game 4. It remains the only win by a human against a full-strength AlphaGo.</p>

  <div class="pull-quote">
    "I never thought AlphaGo could play so perfectly... but today I think I've found the Achilles heel. From now on AlphaGo will be different."
    <cite>â€” Lee Sedol, after winning Game 4</cite>
  </div>

  <div class="info-box">
    <span style="font-size:1.4rem; flex-shrink:0;">ğŸ†</span>
    <div class="info-text">
      <strong>The value of one win</strong>
      When asked about losing the match 4â€“1, Lee said: "If today I was winning three consecutive games and lost one, it would have really hurt. But because I lost three and was able to get one single win â€” I think this one win is so valuable I would not exchange it for anything in the world."
    </div>
  </div>
</section>

<section class="section" id="aftermath">
  <h2><span class="num">07 â€” Aftermath</span>What Happened Next</h2>
  <p>The match's consequences rippled outward â€” through the Go world, through AI research, and through Lee Sedol's own life.</p>

  <div class="cards">
    <div class="card">
      <div class="card-icon">ğŸ“</div>
      <h3>Go Theory Transformed</h3>
      <p>Professional Go players worldwide began studying AlphaGo's games as canonical teaching material. Opening theory that had been stable for centuries was rewritten. Moves once dismissed as amateurish were revealed as profound.</p>
    </div>
    <div class="card">
      <div class="card-icon">ğŸ¤–</div>
      <h3>AlphaGo Zero</h3>
      <p>In 2017, DeepMind released AlphaGo Zero â€” trained with no human games at all, only self-play. It defeated the original AlphaGo 100â€“0. It independently rediscovered known Go principles, then surpassed them entirely.</p>
    </div>
    <div class="card">
      <div class="card-icon">ğŸ”¬</div>
      <h3>AlphaFold Changes Biology</h3>
      <p>The same deep learning techniques used in AlphaGo were applied to protein structure prediction. AlphaFold solved a 50-year grand challenge in biology, predicting the 3D structure of proteins with near-perfect accuracy â€” accelerating drug discovery across the world.</p>
    </div>
    <div class="card">
      <div class="card-icon">ğŸšª</div>
      <h3>Lee Sedol Retires</h3>
      <p>In 2019, Lee Sedol announced his retirement from professional Go. His reason: "There is an entity that cannot be defeated." He was 36 years old. He is the only person who has ever beaten AlphaGo in a formal match.</p>
    </div>
  </div>

  <div class="pull-quote" style="margin-top:2.5rem;">
    "Even if I become the number one, there is an entity that cannot be defeated."
    <cite>â€” Lee Sedol, announcing his retirement from professional Go Â· November 2019</cite>
  </div>

  <p style="margin-top:2rem; font-style:italic; color:var(--muted);">Move 37 was 37 stones into a single game in a match that lasted five days. It took roughly a second to place. It is now one of the most studied and discussed moves in the history of the game â€” not because it won the match, but because it came from somewhere humans hadn't been. It was the first time most people watching understood, viscerally, that AI was not just learning to beat us at our own games. It was learning things we hadn't thought to learn.</p>
</section>

  </div>
</StoryLayout>

<script>
(function () {
  const canvas = document.querySelector('.move-37-canvas') as HTMLCanvasElement | null;
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  if (!ctx) return;

  const ACCENT = '#f59e0b';
  const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

  let W = 0, H = 0, dpr = 1;

  function resize() {
    dpr = window.devicePixelRatio || 1;
    W = canvas.offsetWidth;
    H = canvas.offsetHeight;
    canvas.width = W * dpr;
    canvas.height = H * dpr;
    ctx.scale(dpr, dpr);
  }

  // 9x9 grid layout
  const GRID = 9;

  function gridPoints(w: number, h: number): { x: number; y: number }[] {
    const padX = w * 0.12, padY = h * 0.12;
    const cellW = (w - padX * 2) / (GRID - 1);
    const cellH = (h - padY * 2) / (GRID - 1);
    const pts: { x: number; y: number }[] = [];
    for (let r = 0; r < GRID; r++) {
      for (let c = 0; c < GRID; c++) {
        pts.push({ x: padX + c * cellW, y: padY + r * cellH });
      }
    }
    return pts;
  }

  interface Stone { idx: number; color: 'black' | 'white' | 'amber'; alpha: number; placed: boolean; }

  // Pre-determined stone placements (clustered, plausible Go pattern)
  // Indices into 9x9 grid (row*9+col)
  const HUMAN_MOVES: number[] = [
    40, 38, 42, 31, 49, 30, 22, 48, 32, 50,
    23, 39, 41, 21, 29, 37, 57, 13, 60, 28,
    36, 44, 24, 14, 52, 20, 56, 64, 16, 8,
    34, 46, 25, 43, 35, 27, 53, 45, 55, 47,
    33, 26, 54, 19,
  ]; // 44 stones

  // Move 37 position: 5th line, column 7 (isolated from cluster)
  const MOVE_37_IDX = 6; // row 0, col 6 â€” upper right area, 5th-line feel (row index in the full board would be 4 but we use top-right to suggest 5th line)
  // Actually let's use row=4 (0-indexed), col=7 â†’ idx = 4*9+7 = 43, but 43 is already used.
  // Use row=1, col=7 â†’ idx=16 â€” also used. Let's use row=3, col=8 â†’ idx=35 â€” used.
  // Use row=2, col=8 â†’ idx=26 â€” used.
  // Final: row=0, col=7 â†’ idx=7 (top-right area, clearly isolated)
  const M37 = 7;

  function drawStatic() {
    resize();
    ctx.clearRect(0, 0, W, H);
    const pts = gridPoints(W, H);

    // grid lines
    for (let r = 0; r < GRID; r++) {
      for (let c = 0; c < GRID; c++) {
        const i = r * GRID + c;
        ctx.beginPath();
        ctx.arc(pts[i].x, pts[i].y, 1.5, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(232,232,232,0.06)';
        ctx.fill();
      }
    }

    // ~20 dim stones
    for (let i = 0; i < 20; i++) {
      const idx = HUMAN_MOVES[i];
      const p = pts[idx];
      ctx.beginPath();
      ctx.arc(p.x, p.y, 5, 0, Math.PI * 2);
      ctx.fillStyle = i % 2 === 0 ? 'rgba(232,232,232,0.22)' : 'rgba(40,40,40,0.9)';
      ctx.fill();
    }

    // amber stone
    const m = pts[M37];
    const grad = ctx.createRadialGradient(m.x, m.y, 0, m.x, m.y, 14);
    grad.addColorStop(0, 'rgba(245,158,11,0.5)');
    grad.addColorStop(1, 'rgba(245,158,11,0)');
    ctx.beginPath();
    ctx.arc(m.x, m.y, 14, 0, Math.PI * 2);
    ctx.fillStyle = grad;
    ctx.fill();
    ctx.beginPath();
    ctx.arc(m.x, m.y, 6, 0, Math.PI * 2);
    ctx.fillStyle = ACCENT;
    ctx.fill();
  }

  if (prefersReduced) {
    drawStatic();
    return;
  }

  // Animation phases:
  // Each stone appears every 8 frames â†’ 44*8 = 352f
  // Then Move 37 moment: arc in from off-screen + pulse (80f)
  // Hold (80f), then all fade (60f), restart

  const STONE_INTERVAL = 8;
  const STONES_TOTAL = 44;
  const STONES_PHASE = STONES_TOTAL * STONE_INTERVAL; // 352f
  const ARC_IN_FRAMES = 60;
  const HOLD_FRAMES = 80;
  const PULSE_FRAMES = 60;
  const FADE_FRAMES = 60;
  const TOTAL = STONES_PHASE + ARC_IN_FRAMES + HOLD_FRAMES + PULSE_FRAMES + FADE_FRAMES + 40;

  let frame = 0;
  let rafId: number;
  let stones: Stone[] = [];
  let m37placed = false;
  let pulseFrame = 0;

  function initStones() {
    stones = HUMAN_MOVES.map((idx, i) => ({
      idx,
      color: i % 2 === 0 ? 'white' : 'black',
      alpha: 0,
      placed: false,
    }));
    m37placed = false;
    pulseFrame = 0;
  }

  function ease(t: number) { return t < 0.5 ? 2*t*t : -1+(4-2*t)*t; }

  function draw() {
    frame++;
    ctx.clearRect(0, 0, W, H);

    const pts = gridPoints(W, H);

    // Draw grid dots
    for (let r = 0; r < GRID; r++) {
      for (let c = 0; c < GRID; c++) {
        const i = r * GRID + c;
        ctx.beginPath();
        ctx.arc(pts[i].x, pts[i].y, 1.5, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(232,232,232,0.06)';
        ctx.fill();
      }
    }

    const cycleFrame = frame % TOTAL;

    if (cycleFrame === 0) initStones();

    // Phase 1: place stones
    if (cycleFrame < STONES_PHASE) {
      const stonesVisible = Math.floor(cycleFrame / STONE_INTERVAL);
      for (let i = 0; i < stones.length; i++) {
        if (i < stonesVisible) {
          stones[i].alpha = Math.min(1, stones[i].alpha + 0.08);
          stones[i].placed = true;
        }
      }
    }

    // Phase 2: arc Move 37 in
    const arcStart = STONES_PHASE;
    if (cycleFrame >= arcStart && cycleFrame < arcStart + ARC_IN_FRAMES) {
      // ensure all 44 stones are visible
      for (const s of stones) { s.alpha = 1; s.placed = true; }
      const t = (cycleFrame - arcStart) / ARC_IN_FRAMES;
      const m = pts[M37];
      const startX = W + 30, startY = -30;
      const ex = ease(t);
      const mX = startX + (m.x - startX) * ex;
      const mY = startY + (m.y - startY) * ex;
      // draw arc particle
      ctx.beginPath();
      ctx.arc(mX, mY, 8 * ex, 0, Math.PI * 2);
      ctx.fillStyle = ACCENT;
      ctx.globalAlpha = ex;
      ctx.fill();
      ctx.globalAlpha = 1;
    }

    // Phase 3: hold + pulse
    const holdStart = arcStart + ARC_IN_FRAMES;
    if (cycleFrame >= holdStart) {
      for (const s of stones) { s.alpha = 1; s.placed = true; }
      m37placed = true;
    }

    const pulseStart = holdStart + HOLD_FRAMES;
    const fadeStart = pulseStart + PULSE_FRAMES;

    // Draw all human stones
    for (const s of stones) {
      if (!s.placed || s.alpha <= 0) continue;
      const p = pts[s.idx];
      let alpha = s.alpha;

      // pulse flash
      if (cycleFrame >= holdStart && cycleFrame < holdStart + HOLD_FRAMES + PULSE_FRAMES) {
        const pf = cycleFrame - holdStart;
        const pulseAmt = Math.sin(pf * 0.2) * 0.15;
        alpha = Math.min(1, alpha + pulseAmt);
      }

      // fade out
      if (cycleFrame >= fadeStart) {
        const fadeT = (cycleFrame - fadeStart) / FADE_FRAMES;
        alpha *= 1 - fadeT;
      }

      ctx.beginPath();
      ctx.arc(p.x, p.y, 5, 0, Math.PI * 2);
      ctx.fillStyle = s.color === 'white' ? 'rgba(232,232,232,0.22)' : 'rgba(30,30,30,0.9)';
      ctx.globalAlpha = alpha;
      ctx.fill();
      ctx.globalAlpha = 1;
    }

    // Draw Move 37 amber stone
    if (m37placed || (cycleFrame >= arcStart + ARC_IN_FRAMES)) {
      const m = pts[M37];
      let m37alpha = 1;

      if (cycleFrame >= fadeStart) {
        m37alpha = 1 - (cycleFrame - fadeStart) / FADE_FRAMES;
      }

      const coronaR = 18 + 4 * Math.sin(cycleFrame * 0.05);
      const grad = ctx.createRadialGradient(m.x, m.y, 0, m.x, m.y, coronaR);
      grad.addColorStop(0, 'rgba(245,158,11,0.45)');
      grad.addColorStop(1, 'rgba(245,158,11,0)');
      ctx.beginPath();
      ctx.arc(m.x, m.y, coronaR, 0, Math.PI * 2);
      ctx.fillStyle = grad;
      ctx.globalAlpha = m37alpha;
      ctx.fill();

      ctx.beginPath();
      ctx.arc(m.x, m.y, 6, 0, Math.PI * 2);
      ctx.fillStyle = ACCENT;
      ctx.globalAlpha = m37alpha;
      ctx.fill();
      ctx.globalAlpha = 1;
    }

    rafId = requestAnimationFrame(draw);
  }

  resize();
  initStones();
  rafId = requestAnimationFrame(draw);

  const ro = new ResizeObserver(() => { resize(); });
  ro.observe(canvas);

  window.addEventListener('pagehide', () => {
    cancelAnimationFrame(rafId);
    ro.disconnect();
  });
})();
</script>
